name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'

      - name: Install test dependencies
        run: sudo apt-get update && sudo apt-get install -y libimage-exiftool-perl

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-ui-linux:
    needs: goreleaser
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Linux dependencies
        run: sudo apt-get update && sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@v2.11.0

      - name: Download platform binaries
        run: |
          make apps/ui/build/resources/linux/exiftool
          make apps/ui/build/resources/linux/jpegoptim

      - name: Build frontend
        working-directory: apps/ui/frontend
        run: npm ci && npm run build

      - name: Build UI
        working-directory: apps/ui
        run: wails build -tags webkit2_41 -platform linux/amd64

      - name: Package artefact
        run: |
          cd apps/ui/build/bin
          tar -czvf pics-ui_Linux_x86_64.tar.gz pics-ui
          mv pics-ui_Linux_x86_64.tar.gz ${{ github.workspace }}/

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: pics-ui_Linux_x86_64.tar.gz

  build-ui-windows:
    needs: goreleaser
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@v2.11.0

      - name: Install make
        run: choco install make -y

      - name: Download platform binaries
        shell: bash
        run: |
          make apps/ui/build/resources/windows/exiftool.exe
          make apps/ui/build/resources/windows/jpegoptim.exe

      - name: Build frontend
        working-directory: apps/ui/frontend
        run: npm ci && npm run build

      - name: Build UI
        working-directory: apps/ui
        run: wails build -platform windows/amd64

      - name: Package artefact
        shell: pwsh
        run: Compress-Archive -Path "apps/ui/build/bin/pics-ui.exe" -DestinationPath "pics-ui_Windows_x86_64.zip"

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: pics-ui_Windows_x86_64.zip

  build-ui-macos:
    needs: goreleaser
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@v2.11.0

      - name: Download platform binaries
        run: |
          make apps/ui/build/resources/darwin/exiftool
          make apps/ui/build/resources/darwin/jpegoptim

      - name: Build frontend
        working-directory: apps/ui/frontend
        run: npm ci && npm run build

      - name: Build UI (Universal)
        working-directory: apps/ui
        run: wails build -platform darwin/universal

      - name: Package artefact
        run: |
          cd apps/ui/build/bin
          zip -r pics-ui_macOS_universal.zip pics-ui.app
          mv pics-ui_macOS_universal.zip ${{ github.workspace }}/

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: pics-ui_macOS_universal.zip
