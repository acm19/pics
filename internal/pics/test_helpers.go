package pics

import (
	"os"
	"path/filepath"
	"testing"
	"time"

	"github.com/barasher/go-exiftool"
)

// createTestExiftool creates an exiftool instance for testing and ensures cleanup
func createTestExiftool(t *testing.T) *exiftool.Exiftool {
	t.Helper()
	et, err := exiftool.NewExiftool()
	if err != nil {
		t.Fatalf("Failed to create exiftool: %v", err)
	}
	t.Cleanup(func() { et.Close() })
	return et
}

// createValidJPEGWithDate creates a minimal valid JPEG file with a specific modification time
func createValidJPEGWithDate(t *testing.T, dir, filename string, modTime time.Time) string {
	t.Helper()
	filePath := filepath.Join(dir, filename)

	// More complete minimal JPEG with actual image data (1x1 pixel red image)
	// This JPEG is valid enough for exiftool to write EXIF metadata to it
	minimalJPEG := []byte{
		// SOI (Start of Image)
		0xFF, 0xD8,
		// APP0 (JFIF header)
		0xFF, 0xE0, 0x00, 0x10, 0x4A, 0x46, 0x49, 0x46, 0x00,
		0x01, 0x01, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00,
		// DQT (Define Quantization Table)
		0xFF, 0xDB, 0x00, 0x43, 0x00,
		0x03, 0x02, 0x02, 0x03, 0x02, 0x02, 0x03, 0x03,
		0x03, 0x03, 0x04, 0x03, 0x03, 0x04, 0x05, 0x08,
		0x05, 0x05, 0x04, 0x04, 0x05, 0x0A, 0x07, 0x07,
		0x06, 0x08, 0x0C, 0x0A, 0x0C, 0x0C, 0x0B, 0x0A,
		0x0B, 0x0B, 0x0D, 0x0E, 0x12, 0x10, 0x0D, 0x0E,
		0x11, 0x0E, 0x0B, 0x0B, 0x10, 0x16, 0x10, 0x11,
		0x13, 0x14, 0x15, 0x15, 0x15, 0x0C, 0x0F, 0x17,
		0x18, 0x16, 0x14, 0x18, 0x12, 0x14, 0x15, 0x14,
		// SOF0 (Start of Frame - baseline DCT)
		0xFF, 0xC0, 0x00, 0x0B, 0x08, 0x00, 0x01, 0x00, 0x01, 0x01, 0x01, 0x11, 0x00,
		// DHT (Define Huffman Table)
		0xFF, 0xC4, 0x00, 0x14, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0xFF, 0xC4, 0x00, 0x14, 0x10, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		// SOS (Start of Scan)
		0xFF, 0xDA, 0x00, 0x08, 0x01, 0x01, 0x00, 0x00, 0x3F, 0x00, 0xD2, 0xCF, 0x20,
		// EOI (End of Image)
		0xFF, 0xD9,
	}

	if err := os.WriteFile(filePath, minimalJPEG, 0644); err != nil {
		t.Fatalf("Failed to create valid JPEG %s: %v", filename, err)
	}

	// Set the modification time
	if err := os.Chtimes(filePath, modTime, modTime); err != nil {
		t.Fatalf("Failed to set file times: %v", err)
	}

	return filePath
}
